use encase::ShaderType;

#[derive(Debug, Clone, PartialEq, ShaderType)]
pub struct Lens {
    pub a0: f32,
    pub a1: f32,
    pub a2: f32,
    pub a3: f32,
    pub a4: f32,
    pub a5: f32,
    pub a6: f32,
    pub a7: f32,
    pub a8: f32,
    pub nc: f32,
    pub nd: f32,
    pub nf: f32,
}

impl Lens {
    const fn new(a0: f32, a1: f32, a2: f32, a3: f32, a4: f32, a5: f32, a6: f32, a7: f32, a8: f32, nc: f32, nd: f32, nf: f32) -> Self {
        Self { a0, a1, a2, a3, a4, a5, a6, a7, a8, nc, nd, nf }
    }

    // fn compute_ref_index(lambda_in_micrometers: f32) -> f32 {
    //     0.0
    // }

    pub const LENS_TABLE: [Self; 29] = [
        Self::new(
            2.18826855E+00,
            -9.19044724E-03,
            -1.11621071E-04,
            9.26372815E-03,
            7.34900733E-05,
            4.19724242E-06,
            -1.15412203E-07,
            0.00000000E+00,
            0.00000000E+00,
            1.485343,
            1.487490,
            1.492276,
        ),
        Self::new(
            2.21785004E+00,
            -5.52619544E-03,
            -4.04219098E-05,
            8.39820345E-03,
            8.80190880E-05,
            1.15723877E-07,
            5.38178618E-08,
            0.00000000E+00,
            0.00000000E+00,
            1.495139,
            1.497000,
            1.501226,
        ),
        Self::new(
            2.22016073E+00,
            -5.00725473E-03,
            -3.55507111E-05,
            8.42088796E-03,
            7.02327459E-05,
            2.47007900E-06,
            -6.50002003E-08,
            0.00000000E+00,
            0.00000000E+00,
            1.495980,
            1.497820,
            1.502009,
        ),
        Self::new(
            2.10149795E+00,
            -4.68337833E-03,
            -1.34642385E-05,
            6.77542246E-03,
            4.53499889E-05,
            2.24209054E-06,
            -6.21790903E-08,
            0.00000000E+00,
            0.00000000E+00,
            1.454469,
            1.456000,
            1.459460,
        ),
        Self::new(
            2.27892705E+00,
            -9.04327622E-03,
            -1.10679206E-04,
            1.01870033E-02,
            9.31149884E-05,
            2.72256540E-06,
            -1.82952398E-08,
            0.00000000E+00,
            0.00000000E+00,
            1.516311,
            1.518600,
            1.523731,
        ),
        Self::new(
            2.57826227E+00,
            -9.69723449E-03,
            -1.07085207E-04,
            1.43480110E-02,
            1.59222199E-04,
            5.33085601E-06,
            -5.80638431E-08,
            0.00000000E+00,
            0.00000000E+00,
            1.615024,
            1.618000,
            1.624781,
        ),
        Self::new(
            2.53267453E+00,
            -9.50416844E-03,
            -1.06883723E-04,
            1.34397360E-02,
            1.41770605E-04,
            4.73043880E-06,
            -8.62000830E-08,
            0.00000000E+00,
            0.00000000E+00,
            1.600183,
            1.603000,
            1.609398,
        ),
        Self::new(
            2.50208083E+00,
            -6.72143907E-03,
            -5.34313751E-05,
            1.28264400E-02,
            1.56205388E-04,
            1.21593549E-06,
            9.59550869E-08,
            0.00000000E+00,
            0.00000000E+00,
            1.590540,
            1.593190,
            1.599276,
        ),
        Self::new(
            2.50453078E+00,
            -1.01597822E-02,
            -1.08653142E-04,
            1.27723327E-02,
            1.33860625E-04,
            3.37285381E-06,
            -2.56491019E-08,
            0.00000000E+00,
            0.00000000E+00,
            1.590771,
            1.593490,
            1.599629,
        ),
        Self::new(
            2.60815614E+00,
            -8.16775932E-03,
            0.00000000E+00,
            1.50613778E-02,
            3.69238186E-04,
            -1.11180030E-05,
            1.41616753E-06,
            -6.52373713E-08,
            6.98536029E-09,
            1.625268,
            1.628460,
            1.635889,
        ),
        Self::new(
            2.27110883E+00,
            -9.38988354E-03,
            -1.00277081E-04,
            1.09572221E-02,
            1.20210067E-04,
            3.31079774E-06,
            -1.48235581E-08,
            0.00000000E+00,
            0.00000000E+00,
            1.514324,
            1.516800,
            1.522382,
        ),
        Self::new(
            2.43258691E+00,
            -8.22086723E-03,
            -9.21764324E-05,
            1.43187501E-02,
            1.59799832E-04,
            8.58344462E-06,
            -1.00538104E-07,
            0.00000000E+00,
            0.00000000E+00,
            1.569472,
            1.572500,
            1.579464,
        ),
        Self::new(
            2.33616060E+00,
            -8.18245071E-03,
            -9.82753897E-05,
            1.27499096E-02,
            1.22269251E-04,
            8.48994057E-06,
            -1.59525058E-07,
            0.00000000E+00,
            0.00000000E+00,
            1.537199,
            1.539960,
            1.546271,
        ),
        Self::new(
            2.42114503E+00,
            -8.99959341E-03,
            -9.30006854E-05,
            1.43071120E-02,
            1.89993274E-04,
            6.09602388E-06,
            2.25737069E-07,
            0.00000000E+00,
            0.00000000E+00,
            1.565751,
            1.568830,
            1.575909,
        ),
        Self::new(
            2.27169182E+00,
            -8.15289465E-03,
            -6.46337623E-05,
            1.19516164E-02,
            1.76673730E-04,
            1.45062194E-06,
            2.24852090E-07,
            0.00000000E+00,
            0.00000000E+00,
            1.515551,
            1.518230,
            1.524362,
        ),
        Self::new(
            2.28421062E+00,
            -8.15537489E-03,
            -1.05573054E-04,
            1.22386101E-02,
            1.10833374E-04,
            9.05979458E-06,
            -1.07673777E-07,
            0.00000000E+00,
            0.00000000E+00,
            1.519803,
            1.522490,
            1.528627,
        ),
        Self::new(
            2.54674023E+00,
            -1.22652610E-02,
            -1.34279040E-04,
            1.85970683E-02,
            5.22959966E-04,
            -9.93145010E-06,
            2.37371768E-06,
            0.00000000E+00,
            0.00000000E+00,
            1.608532,
            1.612660,
            1.622313,
        ),
        Self::new(
            2.37404487E+00,
            -1.07631771E-02,
            -1.28642692E-04,
            1.35709369E-02,
            2.55765647E-04,
            -2.23388334E-06,
            4.91067955E-07,
            0.00000000E+00,
            0.00000000E+00,
            1.549923,
            1.552981,
            1.559964,
        ),
        Self::new(
            2.76011543E+00,
            -1.23775063E-02,
            0.00000000E+00,
            2.44484473E-02,
            1.15656997E-03,
            -9.74000173E-05,
            1.85226731E-05,
            -1.41521524E-06,
            5.92951085E-08,
            1.678397,
            1.683760,
            1.696564,
        ),
        Self::new(
            2.92982429E+00,
            -1.15064058E-02,
            -9.01320677E-05,
            2.42192502E-02,
            4.84339860E-04,
            3.92109984E-06,
            7.18628425E-07,
            0.00000000E+00,
            0.00000000E+00,
            1.727358,
            1.732110,
            1.743210,
        ),
        Self::new(
            2.92190512E+00,
            -1.31913454E-02,
            -7.94286252E-05,
            3.27997049E-02,
            7.00950165E-04,
            1.24169090E-04,
            -1.12359582E-05,
            9.11052912E-07,
            0.00000000E+00,
            1.731309,
            1.738000,
            1.754185,
        ),
        Self::new(
            2.26653222E+00,
            -9.74283829E-03,
            -8.49115572E-05,
            1.27195343E-02,
            3.15395806E-04,
            -8.83703038E-06,
            1.84064027E-06,
            0.00000000E+00,
            0.00000000E+00,
            1.514429,
            1.517420,
            1.524341,
        ),
        Self::new(
            2.45156936E+00,
            -8.35914203E-03,
            -8.88499407E-05,
            1.53016408E-02,
            2.24512880E-04,
            5.89498036E-06,
            2.59209632E-07,
            0.00000000E+00,
            0.00000000E+00,
            1.576316,
            1.579570,
            1.587100,
        ),
        Self::new(
            2.45448839E+00,
            -8.67148963E-03,
            -1.04715240E-04,
            1.76039752E-02,
            1.54610243E-04,
            5.59918259E-05,
            -5.01297284E-06,
            3.17557990E-0,
            0.00000000E+00,
            1.578929,
            1.582670,
            1.591464,
        ),
        Self::new(
            2.52175840E+00,
            -9.79498428E-03,
            -1.34973275E-04,
            1.97297837E-02,
            7.13034071E-05,
            1.03716753E-04,
            6.63899530E-07,
            0.00000000E+00,
            0.00000000E+00,
            1.601481,
            1.605620,
            1.615408,
        ),
        Self::new(
            2.58219095E+00,
            -9.86301021E-03,
            -1.16286506E-04,
            1.89733467E-02,
            2.19248923E-04,
            4.98624477E-05,
            -4.45223153E-06,
            3.07817299E-07,
            0.00000000E+00,
            1.619775,
            1.623740,
            1.633044,
        ),
        Self::new(
            2.72808119E+00,
            -9.30210914E-03,
            -7.12221204E-05,
            2.08031569E-02,
            4.57311835E-04,
            -2.96273778E-06,
            1.63114030E-06,
            0.00000000E+00,
            0.00000000E+00,
            1.665785,
            1.670030,
            1.679998,
        ),
        Self::new(
            2.71886836E+00,
            -9.21086428E-03,
            -5.97080099E-05,
            2.02512558E-02,
            4.23467645E-04,
            -1.03717059E-06,
            1.22100678E-06,
            0.00000000E+00,
            0.00000000E+00,
            1.662593,
            1.666720,
            1.676388,
        ),
        Self::new(
            2.62810335E+00,
            -9.95087731E-03,
            -1.44740792E-04,
            2.06473464E-02,
            1.62531777E-04,
            7.85240289E-05,
            -7.45350927E-06,
            4.83617341E-07,
            0.00000000E+00,
            1.635055,
            1.639300,
            1.649314,
        )
    ];
}

// #[derive(Debug, sscanf::FromScanf)]
// #[sscanf(format_unescaped = "{radius}\t{axis_position}\t{n}\t{aperture}", )]
pub struct LensInterface {
    pub radius: f32,
    pub coating_thickness: f32, //coating thicknes = lambda / 4 / n1 [nm]
    pub n: f32,
    pub sa_half: f32,
    pub d0: f32,
    pub flat: bool,
    pub abbe_number: f32,
}

impl LensInterface {
    pub(crate) const AIR_N: f32 = 1.0;

    const NIKON_28_75MM_D6: f32 = 53.142;
    const NIKON_28_75MM_D10: f32 = 7.063;
    const NIKON_28_75MM_D14: f32 = 1.532;
    const NIKON_28_75MM_D_AP: f32 = 2.800;
    const NIKON_28_75MM_D20: f32 = 16.889;
    const NIKON_28_75MM_BF: f32 = 39.683;

    pub const NIKON_28_75MM_APERTURE_ID: u32 = 14; //AP_IDX
    pub const NIKON_28_75MM_NUM_GHOSTS: u32 = 352; // 27!/2*(27-2)!

    pub const NIKON_28_75MM: [LensInterface; 29] = [
        Self::new(72.747, 530.0, 1.60300, 29.0, 2.300, false, 65.42),
        Self::new(37.000, 600.0, Self::AIR_N, 29.0, 13.000, false, 0.0),
        Self::new(-172.809, 570.0, 1.58913, 26.2, 2.100, false, 61.09),
        Self::new(39.894, 660.0, Self::AIR_N, 26.2, 1.000, false, 0.0),
        Self::new(49.820, 330.0, 1.86074, 20.0, 4.400, false, 23.01),
        Self::new(
            74.750,
            544.0,
            Self::AIR_N,
            20.0,
            Self::NIKON_28_75MM_D6,
            false,
            0.0,
        ),
        Self::new(63.402, 740.0, 1.86074, 16.1, 1.600, false, 23.01),
        Self::new(37.530, 411.0, 1.51680, 16.1, 8.600, false, 64.10),
        Self::new(-75.887, 580.0, 1.80458, 16.0, 1.600, false, 25.50),
        Self::new(
            -97.792,
            730.0,
            Self::AIR_N,
            16.5,
            Self::NIKON_28_75MM_D10,
            false,
            0.0,
        ),
        Self::new(96.034, 700.0, 1.62041, 18.0, 3.600, false, 60.14),
        Self::new(261.743, 440.0, Self::AIR_N, 18.0, 0.100, false, 0.0),
        Self::new(54.262, 800.0, 1.69680, 18.0, 6.000, false, 55.60),
        Self::new(
            -5995.277,
            300.0,
            Self::AIR_N,
            18.0,
            Self::NIKON_28_75MM_D14,
            false,
            0.0,
        ),
        Self::new(
            0.0,
            440.0,
            Self::AIR_N,
            7.0,
            Self::NIKON_28_75MM_D_AP,
            true,
            0.0,
        ), //aperture
        Self::new(-74.414, 500.0, 1.90265, 13.0, 2.200, false, 35.72),
        Self::new(-62.929, 770.0, 1.51680, 13.0, 1.450, false, 64.10),
        Self::new(121.380, 820.0, Self::AIR_N, 13.1, 2.500, false, 0.0),
        Self::new(-85.723, 200.0, 1.49782, 13.0, 1.400, false, 82.52),
        Self::new(31.093, 540.0, 1.80458, 13.1, 2.600, false, 25.50),
        Self::new(
            84.758,
            580.0,
            Self::AIR_N,
            13.0,
            Self::NIKON_28_75MM_D20,
            false,
            0.0,
        ),
        Self::new(459.690, 533.0, 1.86074, 15.0, 1.400, false, 23.01),
        Self::new(40.240, 666.0, 1.49782, 15.0, 7.300, false, 82.52),
        Self::new(-49.771, 500.0, Self::AIR_N, 15.2, 0.100, false, 0.0),
        Self::new(62.369, 487.0, 1.67025, 16.0, 7.000, false, 57.53),
        Self::new(-76.454, 671.0, Self::AIR_N, 16.0, 5.200, false, 0.0),
        Self::new(-32.524, 487.0, 1.80454, 17.0, 2.000, false, 39.61),
        Self::new(
            -50.194,
            732.0,
            Self::AIR_N,
            17.0,
            Self::NIKON_28_75MM_BF,
            false,
            0.0,
        ),
        Self::new(0., 500.0, Self::AIR_N, 10., 5., true, 0.0),
    ];

    const fn new(
        radius: f32,
        coating_thickness: f32,
        n: f32,
        sa_half: f32,
        d0: f32,
        flat: bool,
        abbe_number: f32,
    ) -> Self {
        LensInterface {
            radius,
            coating_thickness,
            n,
            sa_half,
            d0,
            flat,
            abbe_number,
        }
    }
}

// impl TryFrom<&str> for LensInterface {
//     type Error = sscanf::Error;
//
//     fn try_from(value: &str) -> Result<Self, Self::Error> {
//         sscanf!(value, "{LensInterface}")
//     }
// }
//
// pub fn parse_lenses(
//     data: &str,
// ) -> Result<Vec<LensInterface>, <LensInterface as TryFrom<&str>>::Error> {
//     data.lines()
//         .filter(|line| !line.is_empty() && !line.starts_with('#'))
//         .map(&str::trim)
//         .map(LensInterface::try_from)
//         .map_ok(|lens| LensInterface {
//             radius: lens.radius,
//             axis_position: lens.axis_position,
//             n: lens.n,
//             aperture: lens.aperture,
//         })
//         .collect()
// }
